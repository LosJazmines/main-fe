import{a as I}from"./chunk-BFSNZW6T.js";import{a as u,b as v}from"./chunk-MNLYAPXW.js";import{l as k}from"./chunk-EWYMWOI3.js";import{a as j}from"./chunk-HE4HGFF6.js";import{a as m,d as U}from"./chunk-2PA5JSTX.js";import{w as i}from"./chunk-OE5DTYP4.js";import{Ya as S,a,b as l,fa as p,ka as d,l as g,pa as h}from"./chunk-W7KOHNRA.js";var L=(()=>{class n{constructor(t,e,r,s){if(this.platformId=t,this._http=e,this.store=r,this.tokenService=s,this.urlUsers=`${j.api}/auth`,this.currentUserSubject=new g(null),this.currentUser$=this.currentUserSubject.asObservable(),i(this.platformId)){let o=localStorage.getItem("currentUser"),f=this.tokenService.getToken();if(o&&f)try{let c=JSON.parse(o);c.token=f,this.currentUserSubject.next(c),this.store.dispatch(u({currentUser:c}))}catch(c){console.error("Error parsing stored user:",c),this.clearStorage()}else this.clearStorage()}}clearStorage(){i(this.platformId)&&(localStorage.removeItem("currentUser"),this.tokenService.removeToken()),this.currentUserSubject.next(null),this.store.dispatch(v())}getToken(){return this.tokenService.getToken()}login(t,e){return this._http.post(`${this.urlUsers}/login`,{email:t,password:e}).pipe(p(r=>{this.tokenService.setToken(r.token);let s=l(a({},r.user),{token:r.token});this.currentUserSubject.next(s),this.store.dispatch(u({currentUser:s})),i(this.platformId)&&localStorage.setItem("currentUser",JSON.stringify(s))}))}googleLogin(t){console.log("Google login called with:",t);let e=new m({"Content-Type":"application/json"});return this._http.post(`${this.urlUsers}/google`,t,{headers:e})}register(t){return this._http.post(`${this.urlUsers}/register`,t).pipe(p(e=>{if(e.user){this.tokenService.setToken(e.token);let r=l(a({},e.user),{token:e.token});i(this.platformId)&&localStorage.setItem("currentUser",JSON.stringify(r)),this.currentUserSubject.next(r),this.store.dispatch(u({currentUser:r}))}}))}registerEmail(t){console.log("email",t);let e=new m({"Content-Type":"application/json"});return this._http.post(`${this.urlUsers}/register-email`,{email:t},{headers:e})}validateToken(t){let e=new m({"Content-Type":"application/json"}),r=`${this.urlUsers}/validate-token`,s={token:t};return this._http.post(r,s,{headers:e})}forgotPassword(t){return this._http.post(`${this.urlUsers}/forgot-password`,{email:t})}resetPassword(t,e){return this._http.post(`${this.urlUsers}/reset-password`,{token:t,password:e})}logout(){this.clearStorage()}getCurrentUser(){return this.currentUserSubject.value}isLoggedIn(){return this.tokenService.isAuthenticated()}updateProfile(t){return this._http.put(`${this.urlUsers}/profile`,t).pipe(p(e=>{let r=this.currentUserSubject.value,s=this.tokenService.getToken();if(r&&s){let o=l(a(a({},r),e),{token:s});i(this.platformId)&&localStorage.setItem("currentUser",JSON.stringify(o)),this.currentUserSubject.next(o),this.store.dispatch(u({currentUser:o}))}}))}static{this.\u0275fac=function(e){return new(e||n)(h(S),h(U),h(k),h(I))}}static{this.\u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{L as a};
